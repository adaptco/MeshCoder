import bpy
import bmesh
import torch
import trimesh
from llama_recipes.blender_scripts.bpy_lib import *

def obtain_mesh():
    delete_all()

    # object name: Bathtub
    # part_1: base
    create_curve(name=['curve_1_1', 'curve_2_1', 'curve_3_1', 'curve_4_1', 'curve_5_1', 'curve_6_1', 'curve_7_1', 'curve_8_1'], control_points=[[[0.29, 0.2, -0.2], [0.0, 0.2, -0.2], [-0.29, 0.2, -0.2], [-0.475, 0.2, -0.24], [-0.475, 0.2, 0.0], [-0.475, 0.2, 0.24], [-0.29, 0.2, 0.2], [0.0, 0.2, 0.2], [0.29, 0.2, 0.2], [0.475, 0.2, 0.24], [0.475, 0.2, 0.0], [0.475, 0.2, -0.24]], [[0.285, 0.165, -0.195], [0.0, 0.165, -0.195], [-0.285, 0.165, -0.195], [-0.47, 0.165, -0.235], [-0.47, 0.165, 0.0], [-0.47, 0.165, 0.235], [-0.285, 0.165, 0.195], [0.0, 0.165, 0.195], [0.285, 0.165, 0.195], [0.47, 0.165, 0.235], [0.47, 0.165, 0.0], [0.47, 0.165, -0.235]], [[0.275, 0.02, -0.19], [0.0, 0.02, -0.19], [-0.275, 0.02, -0.19], [-0.455, 0.02, -0.225], [-0.455, 0.02, 0.0], [-0.455, 0.02, 0.225], [-0.275, 0.02, 0.19], [0.0, 0.02, 0.19], [0.275, 0.02, 0.19], [0.455, 0.02, 0.225], [0.455, 0.02, 0.0], [0.455, 0.02, -0.225]], [[0.255, -0.025, -0.175], [-0.0, -0.025, -0.175], [-0.255, -0.025, -0.175], [-0.425, -0.025, -0.21], [-0.425, -0.025, 0.0], [-0.425, -0.025, 0.21], [-0.255, -0.025, 0.175], [-0.0, -0.025, 0.175], [0.255, -0.025, 0.175], [0.425, -0.025, 0.21], [0.425, -0.025, 0.0], [0.425, -0.025, -0.21]], [[0.23, -0.055, -0.16], [-0.0, -0.055, -0.16], [-0.23, -0.055, -0.16], [-0.39, -0.055, -0.19], [-0.39, -0.055, 0.0], [-0.39, -0.055, 0.19], [-0.23, -0.055, 0.16], [-0.0, -0.055, 0.16], [0.23, -0.055, 0.16], [0.39, -0.055, 0.19], [0.39, -0.055, 0.0], [0.39, -0.055, -0.19]], [[0.2, -0.08, -0.135], [-0.0, -0.08, -0.135], [-0.2, -0.08, -0.135], [-0.335, -0.08, -0.165], [-0.335, -0.08, 0.0], [-0.335, -0.08, 0.165], [-0.2, -0.08, 0.135], [-0.0, -0.08, 0.135], [0.2, -0.08, 0.135], [0.335, -0.08, 0.165], [0.335, -0.08, 0.0], [0.335, -0.08, -0.165]], [[0.155, -0.1, -0.105], [-0.0, -0.1, -0.105], [-0.155, -0.1, -0.105], [-0.26, -0.1, -0.125], [-0.26, -0.1, 0.0], [-0.26, -0.1, 0.125], [-0.155, -0.1, 0.105], [-0.0, -0.1, 0.105], [0.155, -0.1, 0.105], [0.26, -0.1, 0.125], [0.26, -0.1, 0.0], [0.26, -0.1, -0.125]], [[0.065, -0.12, -0.04], [-0.0, -0.12, -0.04], [-0.065, -0.12, -0.04], [-0.105, -0.12, -0.05], [-0.105, -0.12, 0.0], [-0.105, -0.12, 0.05], [-0.065, -0.12, 0.04], [-0.0, -0.12, 0.04], [0.065, -0.12, 0.04], [0.105, -0.12, 0.05], [0.105, -0.12, 0.0], [0.105, -0.12, -0.05]]], handle_type=[3, 3, 3, 3, 3, 3, 3, 3], closed=True)
    bridge_edge_loops(name='BridgeLoop_1', profile_name=['curve_1_1', 'curve_2_1', 'curve_3_1', 'curve_4_1', 'curve_5_1', 'curve_6_1', 'curve_7_1', 'curve_8_1'], number_cuts=4, interpolation='SURFACE', fill_caps='end')
    create_primitive(name='base_1', primitive_type='cube', location=[0.0, -0.2, 0.0], scale=[0.5, 0.23, 0.17], rotation=[0.0, 0.0, 0.71, 0.71])
    boolean_operation(name1='base_1', name2='BridgeLoop_1', operation='DIFFERENCE', solver_mode='FAST')

    # part_2: hole
    create_primitive(name='hole_2', primitive_type='cylinder', location=[-0.01, -0.14, 0.0], scale=[0.01, 0.01, 0.001], rotation=[0.39, 0.39, 0.59, -0.59])


    vertices, faces = get_faces()
    return vertices, faces


if __name__ == '__main__':
    import pdb
    vertices, faces = obtain_mesh()
    mesh_save = trimesh.Trimesh(vertices=vertices.detach().cpu().numpy(), faces=faces.detach().cpu().numpy())
    mesh_save.export('mesh.ply')
    pdb.set_trace()

